name: Minecraft OpenShift Staging

on:
  # pull_request:
  #   types:
  #     - labeled
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs: 
  deploy_staging:
    environment: openshift-staging
    name: 'Staging Minecraft'
    runs-on: ubuntu-latest
    # label to run 
    # if: |
    #   github.event.label.name == 'deploy to staging'

    steps:
      - name: Setup WireGuard connectivity
        run: |
          sudo apt install wireguard resolvconf
          echo '${{ secrets.WG_PRIVATE_KEY }}' > privatekey
          echo '${{ secrets.WG_PRESHARED_KEY }}' > presharedkey
          sudo ip link add dev wg0 type wireguard
          sudo ip address add dev wg0 172.16.100.2/26
          sudo ip link set dev wg0 up
          sudo wg set wg0 listen-port 51820 private-key privatekey peer '${{ secrets.WG_PEER_PUBKEY }}' preshared-key presharedkey endpoint '${{ secrets.WG_ENDPOINT }}' persistent-keepalive 25 allowed-ips '${{ secrets.WG_ALLOWED_IPS }}'
          sudo route add -net 172.16.1.0/26 gw 172.16.100.1 wg0
          sudo resolvconf -u && echo "nameserver 172.16.1.1" | sudo tee /etc/resolvconf/resolv.conf.d/head && sudo resolvconf -u

      - name: checkout-repo
        uses: actions/checkout@v4

      - name: 'Install tools'
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          oc: "latest"

      - name: Authenticate and set namespace
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
          openshift_username: ${{ secrets.OPENSHIFT_USER }}
          openshift_password: ${{ secrets.OPENSHIFT_PASSWORD }}
          certificate_authority_data: ${{ secrets.REDCLOUD_CA }}
          insecure_skip_tls_verify: true

      - name: 'Create Namespace'
        run: |
          oc new-project minecraft-az-staging

      - name: 'Deploy Test'
        uses: redhat-actions/oc-new-app@v1
        with:
          app_name: minecraft
          registry_hostname: ${{ env.REGISTRY }}
          image: ${{ env.REGISTRY }}/ocpdude/minecraft:latest
          namespace: minecraft-az-staging
